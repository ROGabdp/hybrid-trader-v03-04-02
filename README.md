# ğŸš€ Hybrid Trading System V4.1 (Hybrid Optimized) for Taiwan Stock Index (^TWII)

é€™æ˜¯ä¸€å€‹å…ˆé€²çš„æ¼”ç®—æ³•äº¤æ˜“ç³»çµ±ï¼Œçµåˆäº†ç”¨æ–¼åƒ¹æ ¼é æ¸¬çš„ **LSTM-SSAM** (Long Short-Term Memory with Sequential Self-Attention) ä»¥åŠç”¨æ–¼äº¤æ˜“æ±ºç­–çš„ **Pro Trader RL** (Reinforcement Learning)ã€‚

# v03-04-02 æ›´æ–°

- ä¿®æ”¹ ptrl_hybrid_system.py ä¸­çš„ reward function
  - æƒ…å¢ƒ	æ–° Reward
  - è²·å° (action=1, æ¼²å¹…â‰¥10%)	+2.0
  - è²·éŒ¯ (action=1, æ¼²å¹…<10%)	-0.5
  - é”™è¿‡å¥½æœºä¼š (action=0, æ¼²å¹…â‰¥10%)	-1.0
  - æ­£ç¢ºè¿´é¿ (action=0, æ¼²å¹…<10%)	+0.5

- å¾ŒçºŒè¨“ç·´æ­¥æ•¸è¨­å®š:
  - Pre-train Buy: 1,000,000 (èˆŠ)
  - Pre-train Sell: 500,000 (èˆŠ)
  - Fine-tune Buy: 1,000,000 (æ–°)
  - Fine-tune Sell: 500,000 (æ–°)

- ç¨ç«‹æ§åˆ¶ Buy/Sell Agent Fine-tune çš„åŠŸèƒ½ï¼šå› ç‚ºèª¿æ•´éçš„rewardæ•ˆæœä¸éŒ¯ï¼Œä½†buy agentéœ€è¦æ›´å¤šçš„fine tuneæ­¥æ•¸ã€‚(ä¿®æ”¹ç¨‹å¼ç¢¼ï¼Œå¯ä»¥åªé‡è·‘buy agentçš„fine tune)

  ç¾åœ¨çš„è¨­å®š:
  Buy Agent Fine-tune: 1,000,000 æ­¥ (å·²æ›´æ–°)
  Sell Agent Fine-tune: 500,000 æ­¥
      å¦‚ä½•åªé‡è·‘ Buy Agent Fine-tune
      powershell
      # 1. åªåˆªé™¤ Buy Agent çš„ Fine-tune æ¨¡å‹
      Remove-Item .\models_hybrid_v4\ppo_buy_twii_final.zip
      Remove-Item .\models_hybrid_v4\best_tuned\buy\*.zip -ErrorAction SilentlyContinue
      # 2. åŸ·è¡Œè¨“ç·´è…³æœ¬ (æœƒè‡ªå‹•åµæ¸¬ä¸¦åªè¨“ç·´ Buy Agent)
      python train_v4_models.py
      ç¨‹å¼æœƒé¡¯ç¤ºï¼š

      [Check] Step C: Fine-tuning status
        Buy Final:  âŒ Missing
        Sell Final: âœ… Done
      ç„¶å¾ŒåªåŸ·è¡Œ Buy Agent çš„ Fine-tuneï¼Œè·³é Sell Agentã€‚

- æ‰¾å‡ºäº†èª¿æ•´éçš„buy agent reward functionä¹‹å¾Œï¼Œæœ€ä½³çš„Fine-tuneæ­¥æ•¸
    Best Model æ­¥æ•¸: 1,841,472
    Pre-train æ­¥æ•¸:  1,000,000
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Fine-tune æ­¥æ•¸:    841,472 æ­¥ (ç´„ 84 è¬æ­¥)

- æ–°å¢ backtest_v4_dca_hybrid_with_filter_rolling_lstm.pyï¼Œæ–¹ä¾¿æˆ‘æ¯”è¼ƒæœ‰ç„¡æ¿¾ç¶²çš„dca + hybrid çš„å·®ç•° (start 2ç‚ºä¸»)ã€‚
    æŒ‡æ¨™	        With Filter	No Filter	  å·®ç•°
    Total Return	27.37%	    23.44%	    +3.93% ğŸ“ˆ
    Annualized	  29.27%	    25.04%	    +4.23%
    Max Drawdown	-14.40%	    -19.14%	    +4.74% (é¢¨éšªæ›´ä½)
    AI Trades	    13	        27	        äº¤æ˜“æ›´å°‘
    AI Win Rate	  61.5%	      40.7%	      +20.8%
    DCA å€‰	      7	          4	          æ›´å¤š DCA

    é—œéµå·®ç•°
    - æ¿¾ç¶²ç‰ˆæœ¬åªåœ¨ Donchian çªç ´ æ™‚å…è¨± AI è²·å…¥
    - æ¸›å°‘è‰ç‡è²·å…¥ â†’ å‹ç‡æ›´é«˜
    - Max DD é™ä½ â†’ é¢¨éšªæ›´å°
    - DCA æœ‰æ›´å¤šè³‡é‡‘å¯ç”¨
    
    é—œéµçµè«–: æœ‰æ¿¾ç¶²çš„æ¯”è¼ƒé©åˆæˆ‘çš„äº¤æ˜“é¢¨æ ¼ã€‚å³ä¾¿sharp ratioç¨å¾®ä½ä¸€é»(ç›¸è¼ƒæ–¼æ²’æœ‰æ¿¾ç¶²çš„ 3.19ï¼Œæœ‰æ¿¾ç¶²çš„ç¨ä½ä½†ä»æœ‰ 2.83)ï¼Œä¸”ç¸½å ±é…¬ç‡é«˜ï¼Œå‹ç‡é«˜ï¼Œç¸½æå¤±å°ã€‚

- å¾ŒçºŒå¯¦ä½œäº†å¯ä»¥è®€å– å›æ¸¬æŒå€‰ç‹€æ…‹ çš„ ç›¤ä¸­daily_ops_v4_intraday_fixed_lstm.pyï¼Œä¸”æ¡ç”¨äº†å›ºå®šçš„LSTM  backtest_v4_dca_hybrid_with_filter_fixed_lstm.py ä»¥ç¢ºä¿æ¯æ—¥å›æ¸¬çš„çµæœä¸€è‡´ã€‚å› æ­¤å»ºè­°çš„æ“ä½œæµç¨‹ç°¡åŒ–å¦‚ä¸‹:
      ğŸ“… æ¯æ—¥ä¾‹è¡Œå…¬äº‹
      ğŸŒ™ ç›¤å¾Œï¼ˆæ”¶ç›¤å¾ŒåŸ·è¡Œï¼‰
      
      # Step 1: åŸ·è¡Œå›æ¸¬ (æ›´æ–°æŒå€‰åˆ°ä»Šå¤©)
      python backtest_v4_dca_hybrid_with_filter_fixed_lstm.py --start 2025-12-09
      
      é€™æœƒï¼š
      ä¸‹è¼‰æœ€æ–°è‚¡åƒ¹è³‡æ–™
      ç”¨å›ºå®š LSTM åŸ·è¡Œå›æ¸¬
      è¼¸å‡ºä»Šæ—¥çš„æŒå€‰ç‹€æ…‹å’Œæ“ä½œå»ºè­°
      æ›´æ–° open_positions_strat2_*.csvï¼ˆä½ çš„ AI æŒå€‰æ˜ç´°ï¼‰

      # Step 2: åŸ·è¡Œ daily_ops_ç›¤å¾Œ (åŸºæ–¼æœ€æ–°æŒå€‰åˆ¤æ–·)
      python daily_ops_v4_fixed_lstm.py
      
      
      â˜€ï¸ éš”å¤©ç›¤ä¸­ï¼ˆé–‹ç›¤å¾Œä»»æ„æ™‚é–“ï¼‰
      
      # Step 3: åŸ·è¡Œ daily_ops_ç›¤ä¸­ (åŸºæ–¼æœ€æ–°æŒå€‰åˆ¤æ–·)
      python daily_ops_v4_intraday_fixed_lstm.py -i
      
      é€™æœƒï¼š
      æŠ“å–ç›¤ä¸­å³æ™‚åƒ¹æ ¼
      ç”¨ç›¸åŒçš„å›ºå®š LSTM è¨ˆç®—é æ¸¬
      é¡¯ç¤ºæ¯ç­† AI æŒå€‰çš„å³æ™‚å ±é…¬ç‡
      å‘Šè¨´ä½ ä»Šå¤©æ˜¯å¦æ‡‰è©²è²·/è³£

      Fixed LSTM ç›¤ä¸­è…³æœ¬ä¿ç•™äº†å®Œå…¨ç›¸åŒçš„åŠŸèƒ½ï¼š
      # æ–¹å¼ 1: äº’å‹•å¼é¸æ“‡ (ç”¨æ–¹å‘éµ)
      python daily_ops_v4_intraday_fixed_lstm.py -i
      # æ–¹å¼ 2: ç›´æ¥æŒ‡å®šèµ·å§‹æ—¥
      python daily_ops_v4_intraday_fixed_lstm.py --backtest-start 2025-01-02
      # æ–¹å¼ 3: ä½¿ç”¨æœ€æ–° (é è¨­)
      python daily_ops_v4_intraday_fixed_lstm.py

      NOTE: âœ… å·²å¯¦ä½œï¼ç¾åœ¨ daily_ops_v4_intraday_fixed_lstm.py æœƒè‡ªå‹•åŒ¹é…å°æ‡‰çš„ LSTM æ¨¡å‹ï¼šé¸æ“‡å“ªå€‹ CSVï¼Œå°±æœƒè‡ªå‹•è¼‰å…¥å°æ‡‰æ—¥æœŸçš„ Fixed LSTM æ¨¡å‹ï¼é€™æ¨£ä½ å¯ä»¥ä¸¦è¡Œæ¸¬è©¦ä¸åŒæ™‚æœŸçš„ç­–ç•¥ï¼Œæ¯å€‹éƒ½ä½¿ç”¨å„è‡ªæœ€é©åˆçš„æ¨¡å‹ã€‚



    

## âœ¨ æ ¸å¿ƒç‰¹è‰² (Key Features)

| ç‰¹è‰² | èªªæ˜ |
|---------|-------------|
| **æœ¬åœ°è³‡æ–™æ•´åˆ** | TWII æ­·å²è³‡æ–™æ¡æœ¬åœ° CSV ç®¡ç† (`twii_data_from_2000_01_01.csv`)ï¼Œç¢ºä¿æˆäº¤é‡å–®ä½ (å„„å…ƒ) æ­£ç¢ºï¼Œä¸¦å…·å‚™è‡ªå‹•æ›´æ–°æ©Ÿåˆ¶ |
| **åš´è¬¹è¨“ç·´æµç¨‹** | **Data Leakage Prevention**: LSTM æ¨¡å‹è¨“ç·´æ™‚çš„è³‡æ–™ç¸®æ”¾ (Scaling) åš´æ ¼é™åˆ¶åœ¨è¨“ç·´é›†å…§ï¼Œé˜²æ­¢ Look-ahead Bias |
| **LSTM-SSAM é æ¸¬** | T+1 èˆ‡ T+5 åƒ¹æ ¼é æ¸¬ï¼Œä¸¦ä½¿ç”¨ MC Dropout é€²è¡Œä¸ç¢ºå®šæ€§ä¼°è¨ˆ |
| **é·ç§»å­¸ç¿’ (Transfer Learning)** | ä½¿ç”¨å…¨çƒæŒ‡æ•¸é€²è¡Œé è¨“ç·´ (Pre-train) â†’ é‡å° ^TWII é€²è¡Œå¾®èª¿ (Fine-tune) |
| **ç‰¹å¾µèåˆ (Feature Fusion)** | æ•´åˆ 30 ç¨®ç‰¹å¾µï¼ŒåŒ…å« LSTM é æ¸¬ã€ä¿¡å¿ƒåˆ†æ•¸èˆ‡ 6 ç¨®å‡ç·šè¶¨å‹¢ç‰¹å¾µ (Trend/Regime/Bias) |
| **PPO Agent** | åˆ†é›¢çš„è²·å…¥ (Buy) èˆ‡è³£å‡º (Sell) ä»£ç†äººï¼Œä¸¦å…·å‚™é¡åˆ¥å¹³è¡¡æ©Ÿåˆ¶ |
| **å›æ¸¬ (Backtesting)** | å®Œæ•´çš„æ¨¡æ“¬å›æ¸¬ï¼ŒåŒ…å«åœææ©Ÿåˆ¶èˆ‡ç¸¾æ•ˆæŒ‡æ¨™è¨ˆç®— |

## ğŸ“Š ç¸¾æ•ˆçµæœ (2023-Present)

| æŒ‡æ¨™ (Metric) | æ•¸å€¼ (Value) | å‚™è¨» |
|--------|-------|------|
| **ç¸½å ±é…¬ç‡ (Total Return)** | **+47.38%** | Strategy 2 (Shared Pool) |
| **å¹´åŒ–å ±é…¬ç‡ (Annualized)** | **14.09%** | ç©©å¥æˆé•· |
| **å¤æ™®å€¼ (Sharpe Ratio)** | **2.32** ğŸ‘‘ | æ¥µä½³çš„é¢¨éšªèª¿æ•´å›å ± |
| **æœ€å¤§å›æ’¤ (Max Drawdown)** | **-27.8%** | å„ªæ–¼é‡å£“å–®ä¸€ç­–ç•¥ |
| **å‹ç‡ (Win Rate)** | **77.8%** | AI äº¤æ˜“ 45 æ¬¡ (é«˜ä¿¡å¿ƒ) |

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹ (Architecture)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     HYBRID TRADING SYSTEM                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  LSTM T+1    â”‚    â”‚  LSTM T+5    â”‚    â”‚  LSTM T+20   â”‚      â”‚
â”‚  â”‚   é æ¸¬æ¨¡å‹    â”‚    â”‚  + MC Dropoutâ”‚    â”‚  + MC Dropoutâ”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚                   â”‚                   â”‚              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                             â”‚                                    â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚                    â”‚    23 ç‰¹å¾µèåˆ   â”‚                          â”‚
â”‚                    â”‚  (Feature Fusion)â”‚                         â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                             â”‚                                    â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚         â”‚                                       â”‚               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                        â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  Buy Agent  â”‚                        â”‚  Sell Agent â”‚        â”‚
â”‚  â”‚    (PPO)    â”‚                        â”‚    (PPO)    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚         â”‚                                      â”‚                â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                            â”‚                                     â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚                   â”‚    äº¤æ˜“è¨Šè™Ÿ      â”‚                           â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ å°ˆæ¡ˆçµæ§‹ (Project Structure)

```
hybrid-trader-v03-04/
â”œâ”€â”€ ptrl_hybrid_system.py        # æ ¸å¿ƒç³»çµ± (è³‡æ–™è¼‰å…¥/ç‰¹å¾µè¨ˆç®—/è¨“ç·´é‚è¼¯)
â”œâ”€â”€ update_twii_data.py          # è³‡æ–™æ›´æ–°è…³æœ¬ (è‡ªå‹•æŠ“å–æœ€æ–° TWII æ•¸æ“š)
â”œâ”€â”€ twii_data_from_2000_01_01.csv # æœ¬åœ° TWII æ­·å²è³‡æ–™åº« (Volume: å„„å…ƒ)
â”œâ”€â”€ train_v3_models.py           # V3 è¨“ç·´è…³æœ¬ (Lightweight)
â”œâ”€â”€ train_v4_models.py           # V4 è¨“ç·´è…³æœ¬ (Standard)
â”‚
â”œâ”€â”€ # --- æ¯æ—¥ç¶­é‹è…³æœ¬ ---
â”œâ”€â”€ daily_ops_v4.py              # ç›¤å¾Œåˆ†æ (V4)
â”œâ”€â”€ daily_ops_v4_intraday.py     # ç›¤ä¸­åˆ†æ (Rolling LSTM, æ¯æ¬¡é‡è¨“)
â”œâ”€â”€ daily_ops_v4_intraday_fixed_lstm.py  # â­ ç›¤ä¸­åˆ†æ (Fixed LSTM, ç„¡é‡è¨“)
â”œâ”€â”€ daily_ops_dual.py            # é›™ç­–ç•¥æ¯”è¼ƒ (V3+V4)
â”‚
â”œâ”€â”€ # --- å›æ¸¬è…³æœ¬ ---
â”œâ”€â”€ backtest_v4_no_filter.py     # V4 ç„¡æ¿¾ç¶²å›æ¸¬
â”œâ”€â”€ backtest_v4_with_filter.py   # V4 æœ‰æ¿¾ç¶²å›æ¸¬
â”œâ”€â”€ backtest_v4_dca_hybrid_no_filter.py  # DCA æ··åˆç„¡æ¿¾ç¶²
â”œâ”€â”€ backtest_v4_dca_hybrid_with_filter_rolling_lstm.py  # DCA+æ¿¾ç¶²+Rolling LSTM
â”œâ”€â”€ backtest_v4_dca_hybrid_with_filter_fixed_lstm.py    # â­ DCA+æ¿¾ç¶²+Fixed LSTM (æ¨è–¦)
â”‚
â””â”€â”€ # --- è¼¸å‡ºç›®éŒ„ ---
    â”œâ”€â”€ results_backtest_v4_dca_hybrid_with_filter_fixed_lstm/  # Fixed LSTM å›æ¸¬çµæœ
    â”œâ”€â”€ intraday_runs_v4_fixed/                                  # Fixed LSTM ç›¤ä¸­å ±å‘Š
    â””â”€â”€ saved_models_*/                                          # LSTM æ¨¡å‹å„²å­˜
```

## ğŸ› ï¸ å®‰è£èªªæ˜ (Installation)

### å»ºè­°ä½¿ç”¨è™›æ“¬ç’°å¢ƒ (Virtual Environment)
åœ¨ Windows ä¸Šä½¿ç”¨è™›æ“¬ç’°å¢ƒå¯ä»¥é¿å…å¥—ä»¶ç‰ˆæœ¬è¡çªï¼Œå¼·çƒˆå»ºè­°ä½¿ç”¨ã€‚

**æ–¹æ³•ä¸€ï¼šä½¿ç”¨è‡ªå‹•è…³æœ¬ (æ¨è–¦)**
```powershell
.\setup_env.ps1
```

**æ–¹æ³•äºŒï¼šæ‰‹å‹•è¨­å®š**
```powershell
# 1. å»ºç«‹è™›æ“¬ç’°å¢ƒ
python -m venv venv

# 2. å•Ÿå‹•è™›æ“¬ç’°å¢ƒ
.\venv\Scripts\Activate.ps1

# 3. å®‰è£å¥—ä»¶
pip install -r requirements.txt
```

### âš¡ GPU åŠ é€Ÿè¨­å®š (é‡è¦)
æœ¬å°ˆæ¡ˆå»ºè­°ä½¿ç”¨ NVIDIA é¡¯å¡é€²è¡Œè¨“ç·´åŠ é€Ÿã€‚

**æ–¹æ³•ä¸€ï¼šä½¿ç”¨ setup_env.ps1 (è‡ªå‹•)**
è…³æœ¬æœƒè‡ªå‹•å®‰è£æ”¯æ´ CUDA 11.8 çš„ PyTorch ç‰ˆæœ¬ã€‚

**æ–¹æ³•äºŒï¼šæ‰‹å‹•å®‰è£**
è‹¥æ‚¨æ‰‹å‹•åŸ·è¡Œ `pip install -r requirements.txt`ï¼Œé è¨­æœƒå®‰è£ CPU ç‰ˆæœ¬ã€‚è«‹åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤å°‡å…¶æ›¿æ›ç‚º GPU ç‰ˆæœ¬ï¼š

```powershell
# 1. ç§»é™¤ CPU ç‰ˆæœ¬
pip uninstall torch torchvision torchaudio -y

# 2. å®‰è£ GPU ç‰ˆæœ¬ (CUDA 11.8)
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
```

### ç³»çµ±éœ€æ±‚ (Dependencies)

```
tensorflow>=2.10
stable-baselines3>=2.0
gymnasium
yfinance
pandas
numpy>=2.0 (V4 Models Compatibility)
ta
torch
tqdm
matplotlib
psutil
```

## ğŸš€ å¿«é€Ÿé–‹å§‹ (Quick Start)

### 1. è¨“ç·´ LSTM æ¨¡å‹ (é•·é€±æœŸ)

```bash
python train_lstm_models.py
```

### 2. è¨“ç·´ RL æ¨¡å‹ (V3 vs V4)

æœ¬å°ˆæ¡ˆæä¾›å…©å€‹ç‰ˆæœ¬çš„ RL è¨“ç·´è…³æœ¬ï¼Œè«‹ä¾éœ€æ±‚é¸æ“‡ï¼š

| ç‰¹æ€§ | V3 (Lightweight) | V4 (Standard) |
|------|------------------|---------------|
| **ç”¨é€”** | è¼•é‡ç‰ˆï¼Œé©åˆå¿«é€Ÿå¯¦é©— | æ¨™æº–ç‰ˆï¼Œé©åˆå®Œæ•´è¨“ç·´ |
| **Buy Fine-tune** | 200,000 æ­¥ | 1,000,000 æ­¥ |
| **Sell Fine-tune** | 100,000 æ­¥ | 300,000 æ­¥ |
| **æŒ‡ä»¤** | `python train_v3_models.py` | `python train_v4_models.py` |
| **è¼¸å‡ºç›®éŒ„** | `models_hybrid_v3/` | `models_hybrid_v4/` |

### 3. æ¯æ—¥ç¶­é‹ (Daily Operations)

è‡ªå‹•åŒ–è…³æœ¬èƒ½å®Œæˆã€ŒLSTM è¼‰å…¥/è¨“ç·´ â†’ ç‰¹å¾µå·¥ç¨‹ â†’ RL æ¨è«– â†’ å ±å‘Šç”Ÿæˆã€å…¨æµç¨‹ã€‚

#### â­ æ¨è–¦å·¥ä½œæµç¨‹ï¼šFixed LSTM (çµæœä¸€è‡´)

ä½¿ç”¨å›ºå®š LSTM æ¨¡å‹ï¼Œç¢ºä¿å›æ¸¬èˆ‡ç›¤ä¸­åˆ†æä½¿ç”¨ç›¸åŒæ¨¡å‹ï¼Œçµæœå®Œå…¨å¯é‡ç¾ã€‚

**Step 1: ç›¤å¾ŒåŸ·è¡Œå›æ¸¬**
```bash
python backtest_v4_dca_hybrid_with_filter_fixed_lstm.py --start 2025-01-02
```
- é¦–æ¬¡åŸ·è¡Œï¼šè¨“ç·´ä¸¦å„²å­˜ `_fixed` å¾Œç¶´çš„ LSTM æ¨¡å‹
- å¾ŒçºŒåŸ·è¡Œï¼šè‡ªå‹•ä½¿ç”¨ç¾æœ‰ `_fixed` æ¨¡å‹ï¼Œç„¡éœ€é‡è¨“
- è¼¸å‡ºï¼š`lstm_info_*.json`ã€`open_positions_strat2_*.csv`

**Step 2: ç›¤ä¸­å³æ™‚åˆ†æ**
```bash
python daily_ops_v4_intraday_fixed_lstm.py        # ä½¿ç”¨æœ€æ–°å›æ¸¬çµæœ
python daily_ops_v4_intraday_fixed_lstm.py -i     # äº’å‹•é¸æ“‡å›æ¸¬ CSV
python daily_ops_v4_intraday_fixed_lstm.py --backtest-start 2025-01-02  # æŒ‡å®šèµ·å§‹æ—¥
```
- è®€å– `lstm_info_*.json`ï¼Œè¼‰å…¥èˆ‡å›æ¸¬ç›¸åŒçš„ LSTM æ¨¡å‹
- æ ¹æ“šé¸æ“‡çš„ CSV è‡ªå‹•åŒ¹é…å°æ‡‰çš„ LSTM æ¨¡å‹
- é¡¯ç¤ºæ¯ç­† AI æŒå€‰çš„å³æ™‚å ±é…¬ç‡èˆ‡åœæ/åœåˆ©é æ¸¬

**è¼¸å‡ºç›®éŒ„**ï¼š
```
results_backtest_v4_dca_hybrid_with_filter_fixed_lstm/
â”œâ”€â”€ daily_action_strat2_*.csv     # æ¯æ—¥æ“ä½œæ‘˜è¦
â”œâ”€â”€ open_positions_strat2_*.csv   # æœªå¹³å€‰ AI æŒå€‰
â””â”€â”€ lstm_info_*.json              # ä½¿ç”¨çš„ LSTM æ¨¡å‹è·¯å¾‘

intraday_runs_v4_fixed/YYYY-MM-DD_HHMMSS/
â””â”€â”€ reports/
    â”œâ”€â”€ intraday_summary.txt
    â””â”€â”€ intraday_summary.json
```

---

#### ğŸ“Œ å‚³çµ±å·¥ä½œæµç¨‹ (Rolling LSTM)

æ¯æ¬¡åŸ·è¡Œéƒ½é‡æ–°è¨“ç·´ LSTMï¼Œé©åˆéœ€è¦æœ€æ–°æ¨¡å‹çš„æƒ…å¢ƒã€‚

- **ç›¤å¾Œåˆ†æ**:
  ```bash
  python daily_ops_v4.py           # V4 å–®ç­–ç•¥
  python daily_ops_dual.py         # V3+V4 é›™ç­–ç•¥æ¯”è¼ƒ
  ```

- **ç›¤ä¸­å³æ™‚åˆ†æ** (æ¯æ¬¡é‡è¨“ LSTMï¼Œç´„ 20-40 åˆ†é˜):
  ```bash
  python daily_ops_v4_intraday.py    # V4 å°ˆç”¨ (å« T+20/T+5/T+1)
  python daily_ops_dual_intraday.py  # é›™ç­–ç•¥æ¯”è¼ƒç‰ˆ 
  ```

**æµç¨‹èªªæ˜ï¼š**
1. å¾**è­‰äº¤æ‰€ç›¤ä¸­ API** (`mis.twse.com.tw`) ä¸‹è¼‰ç•¶æ—¥å³æ™‚ OHLC
2. ä½¿ç”¨ CSV å‰ 5 æ—¥æˆäº¤é‡å¹³å‡ä½œç‚ºç•¶æ—¥é ä¼°æˆäº¤é‡
3. ä½¿ç”¨ä¸Šè¿°è³‡æ–™å®Œæ•´è¨“ç·´ LSTM æ¨¡å‹ (T+20, T+5, T+1)
4. é€²è¡Œ RL æ¨è«–ä¸¦è¼¸å‡ºå ±å‘Š

---

**åŠŸèƒ½ç‰¹é»ï¼š**
- **å…¨æ™‚æ¨è«–æ¨¡å¼**: ç„¡è«– Donchian æ¿¾ç¶²ç‹€æ…‹ï¼ŒAI éƒ½æœƒåŸ·è¡Œé æ¸¬ä¸¦é¡¯ç¤ºæ„åœ–
- **æ¿¾ç¶²ç‹€æ…‹æ¨™è¨˜**: `BUY`, `WAIT`, `FILTERED (AI: BUY)`, `FILTERED (AI: WAIT)`
- **æƒ…å¢ƒåˆ†æ**: Sell Agent é‡å°ä¸‰ç¨®æŒå€‰æƒ…å¢ƒ (æˆæœ¬å€/ç²åˆ©+10%/è™§æ-5%) æä¾›å»ºè­°
- **æŒå€‰æ˜ç´°**: é¡¯ç¤ºæ¯ç­† AI æŒå€‰çš„è²·å…¥åƒ¹æ ¼ã€ç•¶å‰å ±é…¬ç‡ã€åœæ/åœåˆ©ç‹€æ…‹
- è¼¸å‡º JSON èˆ‡ TXT æˆ°æƒ…å ±å‘Š

### 4. ç­–ç•¥å›æ¸¬ (Backtesting)

æœ¬ç³»çµ±æä¾›å…©ç¨® V4 ç­–ç•¥å›æ¸¬æ¨¡å¼ï¼Œæ–¹ä¾¿è©•ä¼°æ¿¾ç¶²æ•ˆç›Šï¼š

#### A. ç„¡æ¿¾ç¶²æ¨¡å¼ (Aggressive)
æ¸¬è©¦ AI åœ¨**æ¯å¤©éƒ½å¯é€²å ´** (ç„¡ Donchian æ¿¾ç¶²é™åˆ¶) çš„ç¸¾æ•ˆï¼Œè©•ä¼° AI æœ¬èº«çš„åˆ¤æ–·èƒ½åŠ›ã€‚
```bash
python backtest_v4_no_filter.py
```

#### B. æœ‰æ¿¾ç¶²æ¨¡å¼ (Strict)
æ¸¬è©¦ AI åœ¨**åš´æ ¼éµå®ˆæ¿¾ç¶²** (åƒ… Donchian é€šé“çªç ´æ—¥) ä¸‹çš„ç¸¾æ•ˆï¼Œè©•ä¼°æ¿¾ç¶²éæ¿¾é›œè¨Šçš„æ•ˆæœã€‚
```bash
python backtest_v4_with_filter.py
```

**âœ¨ å›æ¸¬ç³»çµ±ç‰¹è‰²ï¼š**

| åŠŸèƒ½ | èªªæ˜ |
|------|------|
| **ä¿¡å¿ƒåº¦å¯è¦–åŒ–** | åœ–è¡¨ä¸Šç›´æ¥æ¨™è¨» AI è²·è³£é»çš„ä¿¡å¿ƒåº¦æ•¸å€¼ (%) |
| **æ¯æ—¥ä¿¡å¿ƒè¨˜éŒ„** | è¼¸å‡º `daily_confidence_*.csv`ï¼Œå®Œæ•´è¨˜éŒ„æ¯æ—¥ AI ä¿¡å¿ƒèˆ‡æ±ºç­– |
| **è‡ªè¨‚æ—¥æœŸç¯„åœ** | é€é `--start` å’Œ `--end` åƒæ•¸æŒ‡å®šå›æ¸¬æœŸé–“ |
| **å‹•æ…‹æª”å** | è¼¸å‡ºæª”æ¡ˆè‡ªå‹•åŒ…å«æ—¥æœŸç¯„åœï¼Œé¿å…è¦†è“‹ |
| **Benchmark æ¯”è¼ƒ** | ç­–ç•¥ç¸¾æ•ˆ vs Buy & Hold ä¸¦æ’é¡¯ç¤º |

### 5. DCA + AI æ··åˆç­–ç•¥å›æ¸¬

æ¸¬è©¦ã€Œå®šæœŸå®šé¡ + AI è‡ªç”±æ“ä½œã€æ··åˆç­–ç•¥çš„ç¸¾æ•ˆã€‚

#### â­ æ¨è–¦ï¼šFixed LSTM ç‰ˆæœ¬ (çµæœä¸€è‡´)

```bash
python backtest_v4_dca_hybrid_with_filter_fixed_lstm.py --start 2025-01-02
```

- ä½¿ç”¨å›ºå®š LSTM æ¨¡å‹ï¼Œæ¯æ¬¡åŸ·è¡Œçµæœå®Œå…¨ä¸€è‡´
- é¦–æ¬¡åŸ·è¡Œè¨“ç·´ä¸¦å„²å­˜ `_fixed` æ¨¡å‹ï¼Œå¾ŒçºŒè‡ªå‹•ä½¿ç”¨
- è¼¸å‡º `lstm_info_*.json` ä¾›ç›¤ä¸­è…³æœ¬è®€å–
- è¼¸å‡º `open_positions_strat2_*.csv` è¨˜éŒ„ AI æŒå€‰æ˜ç´°

#### Rolling LSTM ç‰ˆæœ¬ (æ¯æ¬¡é‡è¨“)

```bash
python backtest_v4_dca_hybrid_with_filter_rolling_lstm.py --start 2025-01-02  # æœ‰æ¿¾ç¶²
python backtest_v4_dca_hybrid_no_filter.py                                     # ç„¡æ¿¾ç¶²
```

**ç­–ç•¥èªªæ˜ï¼š**
1. **Strategy 1: Split 50/50 (è³‡é‡‘å°åŠåˆ†é…)**
   - æ¯å¹´å¹´åˆç²å¾—é¡åº¦ (External Limit) 60 è¬ã€‚
   - é¡åº¦å°åŠæ‹†åˆ†: DCA 30 è¬ (æ¯æœˆ2.5è¬)ï¼ŒAI 30 è¬ã€‚
   - **AI All-in**: ç•¶ AI æ±ºå®šè²·å…¥æ™‚ï¼ŒæœƒæŠ•å…¥ **100%** çš„å¯ç”¨è³‡é‡‘ã€‚

2. **Strategy 2: Shared Pool (è³‡é‡‘æ± å…±äº«)** - **Recommended**
   - æ¯å¹´å¹´åˆç²å¾— 60 è¬é¡åº¦ï¼Œç”± DCA èˆ‡ AI å…±äº«ã€‚
   - **å„ªå…ˆé †åº**: æ¯æœˆ DCA (5è¬) å„ªå…ˆä½¿ç”¨å…§éƒ¨ç¾é‡‘æˆ–é¡åº¦ï¼Œå‰©é¤˜è³‡é‡‘ä¾› AI (æ¯æ¬¡5è¬) ä½¿ç”¨ã€‚
   - **è³‡é‡‘å¾ªç’°**: AI è³£å‡ºå¾Œè³‡é‡‘å›æµè‡³å…§éƒ¨ç¾é‡‘æ± ï¼Œå¯ä¾› DCA æˆ– AI å†æ¬¡ä½¿ç”¨ã€‚

**æ¯”è¼ƒåŸºæº–ï¼š**
1. ç´”å®šæœŸå®šé¡ï¼šæ¯æœˆ 5 è¬å…ƒ (Pure DCA)
2. å¹´åˆä¸€æ¬¡æŠ•å…¥ï¼šæ¯å¹´ 60 è¬ Buy & Hold (Yearly Lump Sum)

**è¼¸å‡ºæª”æ¡ˆ (v3.1 æ›´æ–°)ï¼š**
```
results_backtest_v4_dca_hybrid_no_filter/
â”œâ”€â”€ backtest_comparison_*.png (ç­–ç•¥æ¯”è¼ƒåœ–è¡¨)
â”œâ”€â”€ metrics_comparison_*.csv (ç¸¾æ•ˆæŒ‡æ¨™æ¯”è¼ƒè¡¨)
â”œâ”€â”€ trades_strat1_*.csv (Strategy 1 AI äº¤æ˜“ç´€éŒ„)
â”œâ”€â”€ trades_strat2_*.csv (Strategy 2 AI äº¤æ˜“ç´€éŒ„)
â”œâ”€â”€ daily_confidence_strat1_*.csv (S1 æ¯æ—¥ä¿¡å¿ƒèˆ‡ Action)
â””â”€â”€ daily_confidence_strat2_*.csv (S2 æ¯æ—¥ä¿¡å¿ƒèˆ‡ Action)
```
*è¨»ï¼š`daily_confidence` æª”æ¡ˆåŒ…å« `action` æ¬„ä½ (BUY/SELL/hold/wait) ä¾›è©³ç´°æª¢è¦– AI æ±ºç­–ã€‚*

### ğŸ” å›æ¸¬è…³æœ¬åŠŸèƒ½æ¯”è¼ƒ

| åŠŸèƒ½ | `no_filter` | `with_filter` | `dca_hybrid_no_filter` | `dca_hybrid_fixed_lstm` â­ |
|------|:---:|:---:|:---:|:---:|
| è‡ªè¨‚æ—¥æœŸç¯„åœ | âœ… | âœ… | âœ… | âœ… |
| DCA + AI æ··åˆ | âŒ | âŒ | âœ… | âœ… |
| Donchian æ¿¾ç¶² | âŒ | âœ… | âŒ | âœ… |
| **Fixed LSTM** | âŒ | âŒ | âŒ | âœ… |
| AI æŒå€‰æ˜ç´°è¼¸å‡º | âŒ | âŒ | âŒ | âœ… |
| ç›¤ä¸­è…³æœ¬æ•´åˆ | âŒ | âŒ | âŒ | âœ… |

> [!IMPORTANT]
> **æ¨è–¦ä½¿ç”¨ Fixed LSTM ç‰ˆæœ¬**ï¼š`backtest_v4_dca_hybrid_with_filter_fixed_lstm.py` å¯ç¢ºä¿å›æ¸¬èˆ‡ç›¤ä¸­åˆ†æä½¿ç”¨ç›¸åŒ LSTM æ¨¡å‹ï¼Œçµæœå®Œå…¨ä¸€è‡´ã€‚

## ğŸ“ˆ è¨“ç·´æµç¨‹ (Training Pipeline)

### Phase 1: æ•¸æ“šæ•´åˆ (Unified Data Source)
- **æœ¬åœ°æ•¸æ“š**: ^TWII ä½¿ç”¨æœ¬åœ° `twii_data_from_2000_01_01.csv`ï¼Œç¢ºä¿æˆäº¤é‡å–®ä½æ­£ç¢º (å„„å…ƒ)ã€‚
- **è‡ªå‹•æ›´æ–°**: ç³»çµ±è‡ªå‹•æª¢æŸ¥ä¸¦é€é `update_twii_data.py` è£œé½Šæœ€æ–°äº¤æ˜“æ—¥è³‡æ–™ã€‚
- **åœ‹éš›æŒ‡æ•¸**: ä¸‹è¼‰ 4 å€‹å…¨çƒæŒ‡æ•¸ï¼š^GSPC, ^IXIC, ^SOX, ^DJI (from yfinance)
- **å½±éŸ¿ç¯„åœ**: æ¶µè“‹ V3/V4 è¨“ç·´ã€æ‰€æœ‰å›æ¸¬è…³æœ¬ä»¥åŠæ¯æ—¥ç¶­é‹è…³æœ¬ (Daily Ops)ã€‚

### Phase 2: ç‰¹å¾µå·¥ç¨‹ (Feature Engineering)
- åŒ…å« 24 ç¨®ç‰¹å¾µ (v3.0 æ›´æ–°)ï¼š
  - æ¨™æº–åŒ– OHLC åƒ¹æ ¼
  - å”å¥‡å®‰é€šé“ (Donchian Channel)ã€è¶…ç´šè¶¨å‹¢ (SuperTrend)
  - å¹³å‡Kç·š (Heikin-Ashi) å‹æ…‹
  - RSI, MFI, ATR æŒ‡æ¨™
  - ç›¸å°å¼·åº¦ (Relative Strength) æŒ‡æ¨™
  - **LSTM_Pred_1d**: T+1 é æ¸¬æ¼²å¹…
  - **LSTM_Conf_1d**: T+1 ä¿¡å¿ƒåº¦ (MC Dropout) âœ¨ NEW
  - **LSTM_Pred_5d**: T+5 é æ¸¬æ¼²å¹…
  - **LSTM_Conf_5d**: T+5 ä¿¡å¿ƒåº¦ (MC Dropout)
  - **LSTM_Pred_20d**: T+20 é æ¸¬æ¼²å¹… (New!)
  - **LSTM_Conf_20d**: T+20 ä¿¡å¿ƒåº¦ (MC Dropout) (New!)
  - **[V4.1] é¡¯æ€§ç‰¹å¾µ (Explicit Features)**:
    - `MA20_Slope`: çŸ­æœŸè¶¨å‹¢å‹•èƒ½
    - `Trend_Gap`: å¸‚å ´é«”åˆ¶ (çŸ­é•·ç·šä¹–é›¢)
    - `Bias_MA20`: çŸ­ç·šä¹–é›¢ç‡
    - `Dist_MA60`: å­£ç·šæ”¯æ’è·é›¢
    - `Dist_MA240`: å¹´ç·šç”Ÿå‘½ç·šä½ç½®
    - `Vol_Ratio`: ç›¸å°é‡èƒ½ (RVol)

### Phase 3: é è¨“ç·´ (Pre-training)
- Buy Agent: 1,000,000 æ­¥ (é¡åˆ¥å¹³è¡¡æ¡æ¨£)
- Sell Agent: 500,000 æ­¥

### Phase 4: å¾®èª¿èˆ‡å›æ¸¬ (Fine-tuning & Backtesting)
- å¾®èª¿ï¼šé‡å° ^TWII (2000-2022) é€²è¡Œè¨“ç·´ï¼ŒLearning Rate = 1e-5
- å›æ¸¬ï¼šé©—è­‰æ•¸æ“šé›† (2023-Present)

### âš ï¸ è³‡æ–™ç´€å¾‹ (Data Discipline)

> [!IMPORTANT]
> **é˜²æ­¢è³‡æ–™æ´©æ¼ (Data Leakage Prevention)**
> 
> æœ¬ç³»çµ±æ¡ç”¨åš´æ ¼çš„æ™‚é–“åˆ‡åˆ†ç­–ç•¥ï¼Œç¢ºä¿æ¨¡å‹åœ¨è¨“ç·´æ™‚ä¸æœƒçœ‹åˆ°é©—è­‰æœŸçš„è³‡æ–™ã€‚

| éšæ®µ | è³‡æ–™ç¯„åœ | èªªæ˜ |
|------|----------|------|
| **LSTM è¨“ç·´** | 2000-01-01 ~ 2022-12-31 | ä½¿ç”¨ `train_lstm_models.py` è¨­å®šçš„ `TRAIN_END` |
| **RL é è¨“ç·´** | 2000-01-01 ~ 2022-12-31 | å…¨çƒæŒ‡æ•¸ (^TWII, ^GSPC, ^IXIC, ^SOX, ^DJI) æˆªæ­¢æ–¼ `SPLIT_DATE` |
| **RL å¾®èª¿** | ^TWII < 2023-01-01 | åªç”¨ `SPLIT_DATE` ä¹‹å‰çš„ TWII è³‡æ–™ |
| **RL é©—è­‰/å›æ¸¬** | ^TWII >= 2023-01-01 | æ¨¡å‹å®Œå…¨æ²’è¦‹éçš„è³‡æ–™ |

> [!NOTE]
> **T+20 è¨“ç·´é›†åˆ‡åˆ†ç­–ç•¥ (Adaptive Split)**
> T+20 æ¨¡å‹ç‚ºäº†æ•æ‰æœ€æ–°çš„å¸‚å ´è¶¨å‹¢ï¼Œé è¨­ä½¿ç”¨ **99%** çš„æ­·å²è³‡æ–™é€²è¡Œè¨“ç·´ã€‚
> è‹¥ 99% åˆ‡åˆ†å°è‡´é©—è­‰é›†ä¸è¶³ (å› ç‚º T+20 éœ€è¦æœªä¾†æ¨™ç±¤)ï¼Œç³»çµ±æœƒè‡ªå‹•èª¿æ•´ç­–ç•¥ï¼Œ**å¼·åˆ¶ä¿ç•™æœ€å¾Œ 20 ç­†è³‡æ–™**ä½œç‚ºé©—è­‰é›†ï¼Œè€Œä¸æ˜¯å›é€€åˆ°å‚³çµ±çš„ 80/20 åˆ‡åˆ†ã€‚é€™ç¢ºä¿äº†æ¨¡å‹èƒ½å­¸ç¿’åˆ°æœ€å®Œæ•´çš„è¿‘æœŸèµ°å‹¢ã€‚

**é—œéµè¨­å®š (2025-12-11 æ›´æ–°)ï¼š**
```python
# train_lstm_models.py
TRAIN_END = "2022-12-31"

# train_v3_models.py / train_v4_models.py
SPLIT_DATE = '2023-01-01'
raw_data = hybrid.fetch_index_data(DATA_PATH, start_date="2000-01-01", end_date=SPLIT_DATE)
```

**æ™‚é–“ç·šè¦–è¦ºåŒ–ï¼š**
```
LSTM è¨“ç·´æœŸ:      2000 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2022-12-31
RL è¨“ç·´/å¾®èª¿æœŸ:   2000 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2022-12-31
                                                     â”‚
RL é©—è­‰/å›æ¸¬æœŸ:                                2023-01-01 â”€â”€â”€â”€â”€â”€â”€ ä»Šå¤©
                                               (æ¨¡å‹æœªè¦‹é)
```

### Phase 5: è¨“ç·´ç›£æ§ (Training Monitoring)
æœ¬ç³»çµ±æ•´åˆäº† **TensorBoard** é€²è¡Œè¨“ç·´éç¨‹çš„å³æ™‚ç›£æ§ã€‚

**è‡ªå‹•è¨˜éŒ„çš„æŒ‡æ¨™ï¼š**
- `rollout/ep_rew_mean`: å¹³å‡çå‹µ
- `train/loss`: ç¸½æå¤±
- `train/policy_gradient_loss`: ç­–ç•¥æ¢¯åº¦æå¤±
- `train/value_loss`: åƒ¹å€¼å‡½æ•¸æå¤±
- `train/entropy_loss`: ç†µæå¤±
- `eval/mean_reward`: é©—è­‰é›†å¹³å‡çå‹µ (EvalCallback)

**å¦‚ä½•ä½¿ç”¨ TensorBoardï¼š**
```powershell
# åœ¨å°ˆæ¡ˆç›®éŒ„ä¸‹åŸ·è¡Œ
tensorboard --logdir ./tensorboard_logs/

# ç„¶å¾Œé–‹å•Ÿç€è¦½å™¨å‰å¾€
# http://localhost:6006
```

**æ—¥èªŒå­˜æ”¾ä½ç½®ï¼š**
- `./tensorboard_logs/`: TensorBoard æ—¥èªŒ
- `./logs/`: EvalCallback è©•ä¼°çµæœ
- `models_hybrid/best_tuned/`: é©—è­‰é›†æœ€ä½³æ¨¡å‹

---

## ğŸ“Š è¼¸å‡ºçµæœ (Output)

åŸ·è¡Œ `ptrl_hybrid_system.py` å¾Œï¼Œæ‚¨å°‡ç²å¾—ï¼š

- `models_hybrid/ppo_buy_twii_final.zip`: å¾®èª¿å¾Œçš„ Buy Model
- `models_hybrid/ppo_sell_twii_final.zip`: å¾®èª¿å¾Œçš„ Sell Model
- `results_hybrid/final_performance.png`: ç¸¾æ•ˆåœ–è¡¨
- `tensorboard_logs/`: è¨“ç·´éç¨‹æ—¥èªŒ (å¯ç”¨ TensorBoard æŸ¥çœ‹)

## ğŸ”§ V3 vs V4 ç‰ˆæœ¬æ¯”è¼ƒ

| é …ç›® | V3 (Lightweight) | V4 (Standard) | åŸå§‹ç‰ˆ (ptrl_hybrid_system.py) |
|-----|------------------|-----------------|--------------------------------|
| **Pre-train Buy** | 1,000,000 | 1,000,000 | 1,000,000 |
| **Pre-train Sell** | 500,000 | 500,000 | 500,000 |
| **Fine-tune Buy** | **200,000** | **1,000,000** | 1,000,000 |
| **Fine-tune Sell** | **100,000** | **300,000** | 300,000 |
| **ä¿¡å¿ƒåº¦é–€æª»** | [0.001, 0.010] v2.5 | [0.001, 0.010] v2.5 | [0.005, 0.015] (èˆŠç‰ˆ) |
| **ç‰¹å¾µå¿«å–** | å¼·åˆ¶æ¸…é™¤ | å¼·åˆ¶æ¸…é™¤ | ä½¿ç”¨å¿«å– (éœ€æ‰‹å‹•æ¸…é™¤) |
| **æ¨¡å‹è·¯å¾‘** | `models_hybrid_v3` | `models_hybrid_v4` | `models_hybrid` |

---

## ğŸ”® LSTM ä¿¡å¿ƒåº¦è§£è®€æŒ‡å— (Confidence Interpretation)

### è¨ˆç®—åŸç† (Methodology)
ä¿¡å¿ƒåº¦ (`LSTM_Conf_1d`, `LSTM_Conf_5d`) æ˜¯åŸºæ–¼ **è’™åœ°å¡ç¾… Dropout (MC Dropout)** è¨ˆç®—çš„ï¼š
1. å°åŒä¸€ç­†è³‡æ–™é€²è¡Œ 30 æ¬¡é æ¸¬ï¼ˆæ¯æ¬¡ Dropout éš¨æ©Ÿé®è”½ä¸åŒç¥ç¶“å…ƒï¼‰
2. è¨ˆç®—é€™ 30 æ¬¡é æ¸¬çš„**è®Šç•°ä¿‚æ•¸ (CV)** = æ¨™æº–å·® Ã· å¹³å‡å€¼
3. CV è¶Šå° â†’ æ¨¡å‹è¶Šç©©å®š â†’ ä¿¡å¿ƒåº¦è¶Šé«˜

### é–€æª»è¨­å®š (v3.0)

| æ¨¡å‹ | threshold_high | threshold_low | èªªæ˜ |
|------|----------------|---------------|------|
| **T+1** | 0.008 (0.8%) | 0.040 (4.0%) | ç¯„åœè¼ƒå¯¬ï¼Œé©æ‡‰è¼ƒé«˜çš„ CV åˆ†ä½ˆ |
| **T+5** | 0.001 (0.1%) | 0.010 (1.0%) | ç¯„åœè¼ƒçª„ï¼Œæ¨¡å‹æœ¬èº«è¼ƒç©©å®š |
| **T+20**| 0.010 (1.0%) | 0.030 (3.0%) | é•·é€±æœŸä¸ç¢ºå®šæ€§é«˜ï¼Œé–€æª»é©åº¦æ”¾å¯¬ |

```python
# ptrl_hybrid_system.py add_lstm_features()
# T+1 ä¿¡å¿ƒåº¦
score_1d = 1.0 - (cv - 0.008) / (0.040 - 0.008)
conf_1d = np.clip(score_1d, 0.0, 1.0)

# T+5 ä¿¡å¿ƒåº¦
score_5d = 1.0 - (cv - 0.001) / (0.010 - 0.001)
conf_5d = np.clip(score_5d, 0.0, 1.0)

# T+20 ä¿¡å¿ƒåº¦
score_20d = 1.0 - (cv - 0.010) / (0.030 - 0.010)
conf_20d = np.clip(score_20d, 0.0, 1.0)
```

### åˆ†æ•¸å°ç…§è¡¨

| ä¿¡å¿ƒåº¦ | è§£è®€ | å»ºè­° |
|--------|------|------|
| **0.8+** | ğŸŸ¢ **é«˜ä¿¡å¿ƒ** - æ¨¡å‹éå¸¸ç¢ºå®š | é æ¸¬å¯é åº¦é«˜ï¼Œå¯ä½œç‚ºä¸»è¦åƒè€ƒ |
| **0.6-0.8** | ğŸŸ¡ **ä¸­ç­‰åé«˜** - æ­£å¸¸æ°´æº– | é æ¸¬å¯åƒè€ƒï¼Œä½†éœ€çµåˆå…¶ä»–æŒ‡æ¨™ |
| **0.4-0.6** | ğŸŸ¡ **ä¸­ç­‰** - ç•¥æœ‰ä¸ç¢ºå®šæ€§ | é æ¸¬åƒ…ä¾›è¼”åŠ©åƒè€ƒ |
| **< 0.4** | ğŸ”´ **ä½ä¿¡å¿ƒ** - æ¨¡å‹ä¸ç¢ºå®š | é æ¸¬ä¸ç©©å®šï¼Œè¬¹æ…æ¡ä¿¡ |

### å¯¦éš›æ‡‰ç”¨å»ºè­°
1. **ä¿¡å¿ƒåº¦ 0.8+**ï¼šå¯ä»¥æ›´ç©æ¥µåœ°åƒè€ƒ LSTM çš„æ¼²è·Œé æ¸¬
2. **ä¿¡å¿ƒåº¦ 0.6-0.8**ï¼šé æ¸¬æ–¹å‘å¯åƒè€ƒï¼Œä½†é»ä½é ä¼°éœ€æ‰“æŠ˜æ‰£
3. **ä¿¡å¿ƒåº¦ 0.4-0.6**ï¼šé æ¸¬åƒ…ä¾›è¼”åŠ©åƒè€ƒï¼Œå»ºè­°æ­é…å…¶ä»–æŠ€è¡“æŒ‡æ¨™
4. **ä¿¡å¿ƒåº¦ < 0.4**ï¼šæ¨¡å‹å°ç•¶å¤©çš„åˆ¤æ–·è¼ƒä¸ç¢ºå®šï¼Œå¯èƒ½æ˜¯å› ç‚ºå¸‚å ´è™•æ–¼ç•°å¸¸æ³¢å‹•æœŸ

---

## ğŸ“š åƒè€ƒæ–‡ç» (References)

- **Pro Trader RL**: [Paper Implementation](https://arxiv.org/abs/xxxx)
- **LSTM-SSAM**: Sequential Self-Attention for time series prediction
- **MC Dropout**: Uncertainty estimation via Monte Carlo Dropout

## ğŸ“„ æˆæ¬Š (License)

MIT License

## ğŸ‘¤ ä½œè€… (Author)

Phil Liang

---

*Built with Python, TensorFlow, Stable-Baselines3, and â¤ï¸*
